name: Build

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ '*' ]

  workflow_dispatch:
  schedule:
    - cron: '7 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 50
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -e .[dev]
      - name: Run unit tests
        run: |
          pytest -q
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Build smartentry images
        env:
          # Global budget: keep headroom for other pulls by setting < 100
          PULL_BUDGET: 90
          IMAGES: alpine,centos,debian,fedora,ubuntu,archlinux
          # Map default platforms for each image (can be overridden)
          PLATFORM_MAP_JSON: >-
            {"alpine":"linux/amd64,linux/arm64","centos":"linux/amd64,linux/arm64","debian":"linux/amd64,linux/arm64","fedora":"linux/amd64,linux/arm64","ubuntu":"linux/amd64,linux/arm64","archlinux":"linux/amd64"}
          SKIP_REMOVE: false
          DOCKER_PUSH: "${{ (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/ci') && 'true' || '' }}"
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          DOCKER_PASS: ${{ secrets.DOCKER_PASS }}
        run: |
          smartentry-build
